<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Flow Popup Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .results {
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-line;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .info { color: blue; }
        .debug { color: gray; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">RDC Popup Simulation</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <h3 class="card-title">Current Production Method</h3>
                <p><em>Uses `window.open` to open a popup and check if it was blocked, then act accordingly.</em></p>
                <hr />
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="performDetection" checked>
                    <label class="form-check-label" for="performDetection">Perform popup detection check</label>
                </div>
                <div class="d-flex gap-2 align-items-center mb-3">
                    <button class="btn btn-primary btn-lg" onclick="runExactProductionFlow()">Simulate "Get Started" Click</button>
                </div>
                <div id="results" class="results border p-3 bg-light rounded"></div>
            </div>
        </div>
    </div>

    <script>
        function log(msg, type = 'info') {
            const el = document.getElementById('results');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `<span class="${type}">[${time}] ${msg}</span>\n`;
            el.scrollTop = el.scrollHeight;
        }

        function clear() {
            document.getElementById('results').innerHTML = '';
        }

        function detectPopupBlocker() {
            let popup = null;
            let isBlocked = false;

            try {
                const testName = `bluebidTest_${Math.random().toString(36).substr(2, 9)}`;
                popup = window.open('', testName, 'width=1,height=1,left=-1000,top=-1000');
                isBlocked = !popup || popup.closed || typeof popup.closed === 'undefined';
            } catch {
                isBlocked = true;
            }

            if (popup && !popup.closed) {
                try {
                    popup.close();
                } catch (cleanupError) {
                    console.error('failed to cleanup popup during detection', cleanupError);
                }
            }

            return isBlocked;
        }

        function createRdcRedirectContext(userAgent) {
            const isPopupBlocked = detectPopupBlocker();
            return { isPopupBlocked };
        }

        function detectPopupBlocking(params) {
            const redirectContext = createRdcRedirectContext(params.userAgent);
            return redirectContext.isPopupBlocked;
        }

        function simulateRdcPopup() {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = 'https://httpbin.org/post';
            form.target = '_blank';
            form.style.display = 'none';
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        async function apiCall(delay) {
            await fetch(`https://httpbin.org/delay/${delay}`, { method: 'POST' });
        }

        async function runExactProductionFlow() {
            clear();
            log('User clicked "Get Started" button', 'info');
            
            const shouldPerformDetection = document.getElementById('performDetection').checked;
            
            log('React: setTerminatingIncompleteClaimFlow(true)', 'debug');
            await new Promise(resolve => setTimeout(resolve, 0));
            
            log('React: setIsRdcRedirecting(true)', 'debug');
            await new Promise(resolve => setTimeout(resolve, 0));
            
            log('API: await terminateIncompleteClaimFlow()', 'debug');
            await apiCall(0.1);
            
            log('API: await verifyRdcRedirectAllowed()', 'debug');
            await apiCall(0.15);
            
            if (shouldPerformDetection) {
                log('Running popup detection through production layers...', 'info');
                const needsPopupProtection = detectPopupBlocking({ userAgent: navigator.userAgent });
                log(`Production Result: ${needsPopupProtection ? 'BLOCKED' : 'ALLOWED'}`, needsPopupProtection ? 'error' : 'success');
                
                if (needsPopupProtection) {
                    log('Production: Using same-window redirect', 'warning');
                } else {
                    log('Production: Using popup redirect', 'success');
                }
            } else {
                log('Skipping popup detection', 'warning');
            }
            
            log('Attempting RDC redirect...', 'info');
            simulateRdcPopup();
            log('Test complete. Check for new tab/window.', 'info');
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 